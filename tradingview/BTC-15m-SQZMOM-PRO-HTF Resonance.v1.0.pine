//@version=6
strategy(
     "BTC SQZMOM PRO v3.0 (HTF Resonance)",
     overlay=false,
     initial_capital=100000,
     pyramiding=0,
     default_qty_type=strategy.percent_of_equity,
     default_qty_value=100,
     commission_type=strategy.commission.percent,
     commission_value=0.04)

//==================================================
// ðŸ”§ å‚æ•°
//==================================================
bbLen   = input.int(20, "BB Length")
bbMult  = input.float(2.0, "BB Mult")
kcLen   = input.int(20, "KC Length")
kcMult  = input.float(1.5, "KC Mult")
useTR   = input.bool(true, "Use TrueRange")

htfTF   = input.timeframe("60", "HTF")
emaLen  = input.int(200, "EMA Trend")
atrLen  = input.int(14, "ATR")

baseRR  = input.float(1.8, "Base RR")
maxRR   = input.float(3.0, "Max RR")

maxLossStreak = input.int(3, "Max Losing Streak")

//==================================================
// â° BTC æ—¶æ®µè¿‡æ»¤ï¼ˆUTCï¼‰
//==================================================
h = hour(time)
asia  = h >= 0  and h <= 8
us    = h >= 13 and h <= 20
sessionOK = asia or us

//==================================================
// ðŸ“ SQZMOM å‡½æ•°ï¼ˆç¨³å®šç‰ˆï¼‰
//==================================================
f_sqzmom(_src) =>
    basis = ta.sma(_src, bbLen)
    dev   = bbMult * ta.stdev(_src, bbLen)
    upperBB = basis + dev
    lowerBB = basis - dev

    ma = ta.sma(_src, kcLen)
    rng = useTR ? ta.tr(true) : high - low
    rangema = ta.sma(rng, kcLen)
    upperKC = ma + rangema * kcMult
    lowerKC = ma - rangema * kcMult

    sqzOn  = (lowerBB > lowerKC) and (upperBB < upperKC)
    sqzOff = (lowerBB < lowerKC) and (upperBB > upperKC)

    mid = (ta.highest(high, kcLen) + ta.lowest(low, kcLen)) / 2
    mid2 = (mid + ta.sma(close, kcLen)) / 2
    val = ta.linreg(_src - mid2, kcLen, 0)

    [sqzOn, sqzOff, val]

//==================================================
// ðŸ”¹ LTF & HTF SQZMOM
//==================================================
[l_sqzOn, l_sqzOff, l_val] = f_sqzmom(close)
[h_sqzOn, h_sqzOff, h_val] = request.security(syminfo.tickerid, htfTF, f_sqzmom(close))

//==================================================
// ðŸ“ˆ è¶‹åŠ¿ & é£ŽæŽ§
//==================================================
ema200 = ta.ema(close, emaLen)
atr    = ta.atr(atrLen)

// åŠ¨æ€ RRï¼ˆsqueeze å¼ºåº¦ï¼‰
strength = math.abs(l_val) / atr
dynRR = math.min(maxRR, baseRR + strength)

//==================================================
// ðŸš« è¿žç»­äºæŸç†”æ–­
//==================================================
var int lossStreak = 0
if strategy.closedtrades > 0
    lastPL = strategy.closedtrades.profit(strategy.closedtrades - 1)
    lossStreak := lastPL < 0 ? lossStreak + 1 : 0

canTrade = lossStreak < maxLossStreak

//==================================================
// âœ… å…¥åœºæ¡ä»¶ï¼ˆé»„é‡‘çª—å£ï¼‰
//==================================================
longCond =
     sessionOK and
     canTrade and
     close > ema200 and
     h_sqzOff and
     l_sqzOff and
     l_val > 0 and
     l_val > l_val[1]

shortCond =
     sessionOK and
     canTrade and
     close < ema200 and
     h_sqzOff and
     l_sqzOff and
     l_val < 0 and
     l_val < l_val[1]

//==================================================
// ðŸŽ¯ åˆ†æ‰¹æ­¢ç›ˆæ‰§è¡Œ
//==================================================
if longCond
    strategy.entry("LONG", strategy.long)
    strategy.exit("TP1_L", "LONG", limit = close + atr * dynRR, qty_percent = 50)
    strategy.exit("TP2_L", "LONG", stop  = close - atr)

if shortCond
    strategy.entry("SHORT", strategy.short)
    strategy.exit("TP1_S", "SHORT", limit = close - atr * dynRR, qty_percent = 50)
    strategy.exit("TP2_S", "SHORT", stop  = close + atr)

//==================================================
// ðŸ“Š å¯è§†åŒ–
//==================================================
plot(l_val,
     style=plot.style_histogram,
     color = l_val > 0 ? (l_val > l_val[1] ? color.lime : color.green)
                       : (l_val < l_val[1] ? color.red : color.maroon),
     linewidth=4)

plot(0, color = l_sqzOn ? color.black : l_sqzOff ? color.gray : color.blue)
